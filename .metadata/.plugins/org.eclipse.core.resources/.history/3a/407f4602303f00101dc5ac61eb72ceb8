package chatbotorioai;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;
import java.sql.*;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.*;

public class ChatServlet extends HttpServlet {

    private Map<String, String> sessionData = new HashMap<>();
    private int etapa = -1;
    private String modo = "";
    private boolean confirmacaoCancelamento = false;
    private String cpfParaCancelar = "";

    private static final List<String> DATAS = generateDates();
    private static final List<String> HORARIOS = Arrays.asList(
        "08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"
    );

    @Override
    public void init() throws ServletException {
        String realPath = getServletContext().getRealPath("/");
        Database.setDatabasePath(realPath);
        Database.inicializarBanco();
    }

    private static List<String> generateDates() {
        List<String> datas = new ArrayList<>();
        LocalDate start = LocalDate.now().plusDays(1);
        LocalDate end = start.plusMonths(1);
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");

        while (!start.isAfter(end)) {
            if (!(start.getDayOfWeek() == DayOfWeek.SATURDAY || start.getDayOfWeek() == DayOfWeek.SUNDAY)) {
                datas.add(start.format(formatter));
            }
            start = start.plusDays(1);
        }
        return datas;
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String userMessage = request.getParameter("message").trim();
        response.setContentType("text/plain");
        PrintWriter out = response.getWriter();

        if (userMessage.equalsIgnoreCase("sair")) {
            resetarConversa();
            out.println("Agradecemos pelo contato. Sess√£o encerrada.");
            return;
        }

        if (etapa == -1) {
            returnMenuInicial(out);
            etapa = -2;
            return;
        }

        if (etapa == -2) {
            switch (userMessage) {
                case "1":
                    modo = "agendar";
                    etapa = 0;
                    out.println("√ìtimo! Vamos iniciar seu agendamento.\nPor favor, informe seu nome completo:");
                    break;
                case "2":
                    modo = "consultar";
                    etapa = 100;
                    out.println("Por favor, informe seu CPF para consultar seu agendamento:");
                    break;
                case "3":
                    modo = "desmarcar";
                    etapa = 200;
                    out.println("Informe o CPF vinculado √† consulta que deseja cancelar:");
                    break;
                default:
                    out.println("Op√ß√£o inv√°lida. Digite:\n1) Agendar consulta\n2) Consultar agendamento\n3) Cancelar consulta");
            }
            return;
        }

        String botResponse = processarMensagem(userMessage);
        out.println(botResponse);
    }

    private String processarMensagem(String userMessage) {
        switch (modo) {
            case "agendar":
                return fluxoAgendamento(userMessage);
            case "consultar":
                return fluxoConsulta(userMessage);
            case "desmarcar":
                return fluxoDesmarcar(userMessage);
            default:
                resetarConversa();
                return "Erro no fluxo. Reiniciando atendimento...";
        }
    }

    // ====== Valida√ß√µes ======
    private boolean validarCPF(String cpf) {
        return cpf != null && cpf.matches("\\d{11}");
    }

    private boolean validarTelefone(String telefone) {
        return telefone != null && telefone.matches("\\d{10,11}");
    }

    private boolean validarEmail(String email) {
        return email != null && email.matches("^[\\w-.]+@([\\w-]+\\.)+[\\w-]{2,4}$");
    }

    private boolean validarNascimento(String nascimento) {
        try {
            LocalDate.parse(nascimento, DateTimeFormatter.ofPattern("yyyy-MM-dd"));
            return true;
        } catch (DateTimeParseException e) {
            return false;
        }
    }

    private boolean validarEndereco(String endereco) {
        String[] partes = endereco.split(",");
        return partes.length == 6;
    }

    private boolean validarPlanoSaude(String plano) {
        if (plano.equalsIgnoreCase("n√£o")) {
            return true;
        }
        String[] partes = plano.split(",");
        return partes.length == 3;
    }

    private boolean validarTextoLivre(String texto) {
        return texto != null && texto.length() > 3;
    }

    // ====== Fluxo Agendamento ======
    private String fluxoAgendamento(String userMessage) {
        switch (etapa) {
            case 0:
                if (!validarTextoLivre(userMessage)) return "Nome inv√°lido. Informe seu nome completo:";
                sessionData.put("nome", userMessage);
                etapa++;
                return "Informe seu CPF (somente n√∫meros, 11 d√≠gitos):";
            case 1:
                if (!validarCPF(userMessage)) return "CPF inv√°lido. Informe um CPF v√°lido (11 n√∫meros):";
                sessionData.put("cpf", userMessage);
                etapa++;
                return "Informe seu telefone (DDD + n√∫mero, somente n√∫meros):";
            case 2:
                if (!validarTelefone(userMessage)) return "Telefone inv√°lido. Exemplo: 11999999999.";
                sessionData.put("telefone", userMessage);
                etapa++;
                return "Informe seu e-mail:";
            case 3:
                if (!validarEmail(userMessage)) return "E-mail inv√°lido. Exemplo: exemplo@email.com.";
                sessionData.put("email", userMessage);
                etapa++;
                return "Informe sua data de nascimento (YYYY-MM-DD):";
            case 4:
                if (!validarNascimento(userMessage)) return "Data de nascimento inv√°lida. Exemplo: 1990-05-20.";
                sessionData.put("nascimento", userMessage);
                etapa++;
                return "Informe seu endere√ßo:\nRua, N√∫mero, Bairro, Cidade, Estado, CEP\nExemplo: Avenida Paulista, 1000, Bela Vista, S√£o Paulo, SP, 01310-000";
            case 5:
                if (!validarEndereco(userMessage)) return "Endere√ßo inv√°lido. Informe no formato: Rua, N√∫mero, Bairro, Cidade, Estado, CEP.";
                sessionData.put("endereco", userMessage);
                etapa++;
                return "Possui plano de sa√∫de? Informe:\nNome do Plano, N√∫mero do Cart√£o, Validade (YYYY-MM-DD)\nOu digite 'n√£o':";
            case 6:
                if (!validarPlanoSaude(userMessage)) return "Informa√ß√µes inv√°lidas. Exemplo: Unimed,1234567890,2025-12-31 ou digite 'n√£o'.";
                sessionData.put("plano_saude", userMessage);
                etapa++;
                return "Descreva seu hist√≥rico m√©dico:";
            case 7:
                if (!validarTextoLivre(userMessage)) return "Hist√≥rico m√©dico inv√°lido. Forne√ßa mais detalhes.";
                sessionData.put("historico_medico", userMessage);
                etapa++;
                return "Descreva os sintomas atuais:";
            case 8:
                if (!validarTextoLivre(userMessage)) return "Descri√ß√£o inv√°lida. Forne√ßa mais detalhes:";
                sessionData.put("sintomas", userMessage);
                etapa++;
                return "Informe a especialidade m√©dica desejada:";
            case 9:
                if (!validarTextoLivre(userMessage)) return "Especialidade inv√°lida. Informe uma especialidade v√°lida:";
                sessionData.put("especialidade", userMessage);
                etapa++;
                return "Escolha uma data para a consulta:\n" + formatarOpcoes(DATAS);
            case 10:
                try {
                    int dataEscolhida = Integer.parseInt(userMessage) - 1;
                    if (dataEscolhida >= 0 && dataEscolhida < DATAS.size()) {
                        sessionData.put("data", DATAS.get(dataEscolhida));
                        etapa++;
                        return "Escolha um hor√°rio:\n" + formatarOpcoes(HORARIOS);
                    } else {
                        return "Op√ß√£o inv√°lida. Escolha uma data v√°lida:\n" + formatarOpcoes(DATAS);
                    }
                } catch (NumberFormatException e) {
                    return "Formato inv√°lido. Informe o n√∫mero da data desejada:\n" + formatarOpcoes(DATAS);
                }
            case 11:
                try {
                    int horaEscolhida = Integer.parseInt(userMessage) - 1;
                    if (horaEscolhida >= 0 && horaEscolhida < HORARIOS.size()) {
                        sessionData.put("hora", HORARIOS.get(horaEscolhida));
                        salvarInformacoes();
                        String dataConfirmada = sessionData.get("data");
                        String horaConfirmada = sessionData.get("hora");
                        resetarConversa();
                        return "‚úÖ Consulta agendada para " + dataConfirmada + " √†s " + horaConfirmada + ".\nDeseja realizar outro atendimento? (sim / sair)";
                    } else {
                        return "Op√ß√£o inv√°lida. Escolha um hor√°rio v√°lido:\n" + formatarOpcoes(HORARIOS);
                    }
                } catch (NumberFormatException e) {
                    return "Formato inv√°lido. Informe o n√∫mero do hor√°rio desejado:\n" + formatarOpcoes(HORARIOS);
                }
            default:
                resetarConversa();
                return "Houve um problema. Vamos recome√ßar.";
        }
    }

    // ====== Fluxo Consulta ======
    private String fluxoConsulta(String userMessage) {
        if (!validarCPF(userMessage)) {
            return "CPF inv√°lido. Informe um CPF v√°lido para consultar o agendamento:";
        }
        try (Connection conn = Database.connect();
             PreparedStatement stmt = conn.prepareStatement(
                     "SELECT data_consulta, hora_consulta FROM agendamento " +
                     "JOIN paciente ON paciente.id = agendamento.paciente_id WHERE paciente.cpf = ?")) {
            stmt.setString(1, userMessage);
            ResultSet rs = stmt.executeQuery();
            if (rs.next()) {
                String data = rs.getString("data_consulta");
                String hora = rs.getString("hora_consulta");
                resetarConversa();
                return "üìÖ Consulta marcada para: " + data + " √†s " + hora + ".\nDeseja realizar outra opera√ß√£o? (sim / sair)";
            } else {
                resetarConversa();
                return "Nenhuma consulta encontrada para este CPF.\nDeseja realizar outra opera√ß√£o? (sim / sair)";
            }
        } catch (SQLException e) {
            e.printStackTrace();
            resetarConversa();
            return "Erro ao consultar agendamento. Vamos tentar novamente.";
        }
    }

    // ====== Fluxo Desmarcar Consulta ======
    private String fluxoDesmarcar(String userMessage) {
        if (confirmacaoCancelamento) {
            if (userMessage.equalsIgnoreCase("sim")) {
                return cancelarConsulta();
            } else {
                resetarConversa();
                return "Cancelamento abortado. Deseja realizar outra opera√ß√£o? (sim / sair)";
            }
        }

        if (!validarCPF(userMessage)) {
            return "CPF inv√°lido. Informe um CPF v√°lido para cancelar a consulta:";
        }

        try (Connection conn = Database.connect();
             PreparedStatement checkStmt = conn.prepareStatement(
                     "SELECT id FROM paciente WHERE cpf = ?")) {
            checkStmt.setString(1, userMessage);
            ResultSet rs = checkStmt.executeQuery();
            if (rs.next()) {
                cpfParaCancelar = userMessage;
                confirmacaoCancelamento = true;
                return "Tem certeza que deseja cancelar a consulta vinculada a este CPF? (sim / n√£o)";
            } else {
                resetarConversa();
                return "CPF n√£o encontrado.\nDeseja realizar outra opera√ß√£o? (sim / sair)";
            }
        } catch (SQLException e) {
            e.printStackTrace();
            resetarConversa();
            return "Erro ao processar cancelamento. Vamos tentar novamente.";
        }
    }

    private String cancelarConsulta() {
        try (Connection conn = Database.connect();
             PreparedStatement deleteStmt = conn.prepareStatement(
                     "DELETE FROM agendamento WHERE paciente_id = (SELECT id FROM paciente WHERE cpf = ?)")) {
            deleteStmt.setString(1, cpfParaCancelar);
            int rowsAffected = deleteStmt.executeUpdate();
            resetarConversa();
            if (rowsAffected > 0) {
                return "‚úÖ Consulta cancelada com sucesso.\nDeseja realizar outra opera√ß√£o? (sim / sair)";
            } else {
                return "Nenhuma consulta encontrada para este CPF.\nDeseja realizar outra opera√ß√£o? (sim / sair)";
            }
        } catch (SQLException e) {
            e.printStackTrace();
            resetarConversa();
            return "Erro ao cancelar a consulta.";
        }
    }

    private void salvarInformacoes() {
        try (Connection conn = Database.connect()) {
            conn.setAutoCommit(false);

            try (PreparedStatement pacienteStmt = conn.prepareStatement(
                    "INSERT INTO paciente (nome, cpf, telefone, email, nascimento) VALUES (?, ?, ?, ?, ?)",
                    Statement.RETURN_GENERATED_KEYS)) {
                pacienteStmt.setString(1, sessionData.get("nome"));
                pacienteStmt.setString(2, sessionData.get("cpf"));
                pacienteStmt.setString(3, sessionData.get("telefone"));
                pacienteStmt.setString(4, sessionData.get("email"));
                pacienteStmt.setString(5, sessionData.get("nascimento"));
                pacienteStmt.executeUpdate();

                ResultSet rs = pacienteStmt.getGeneratedKeys();
                if (rs.next()) {
                    int pacienteId = rs.getInt(1);

                    // Endere√ßo
                    String[] enderecoParts = sessionData.get("endereco").split(",");
                    try (PreparedStatement enderecoStmt = conn.prepareStatement(
                            "INSERT INTO endereco (paciente_id, rua, numero, bairro, cidade, estado, cep) VALUES (?, ?, ?, ?, ?, ?, ?)")) {
                        enderecoStmt.setInt(1, pacienteId);
                        for (int i = 0; i < 6; i++) {
                            enderecoStmt.setString(i + 2, enderecoParts[i].trim());
                        }
                        enderecoStmt.executeUpdate();
                    }

                    // Plano de sa√∫de
                    if (!sessionData.get("plano_saude").equalsIgnoreCase("n√£o")) {
                        String[] planoParts = sessionData.get("plano_saude").split(",");
                        try (PreparedStatement planoStmt = conn.prepareStatement(
                                "INSERT INTO plano_saude (paciente_id, nome, numero_cartao, validade) VALUES (?, ?, ?, ?)")) {
                            planoStmt.setInt(1, pacienteId);
                            for (int i = 0; i < 3; i++) {
                                planoStmt.setString(i + 2, planoParts[i].trim());
                            }
                            planoStmt.executeUpdate();
                        }
                    }

                    // Hist√≥rico m√©dico
                    try (PreparedStatement historicoStmt = conn.prepareStatement(
                            "INSERT INTO historico_medico (paciente_id, diagnostico, tratamentos, exames_realizados) VALUES (?, ?, ?, ?)")) {
                        historicoStmt.setInt(1, pacienteId);
                        historicoStmt.setString(2, sessionData.get("historico_medico"));
                        historicoStmt.setString(3, "N/A");
                        historicoStmt.setString(4, "N/A");
                        historicoStmt.executeUpdate();
                    }

                    // Triagem
                    try (PreparedStatement triagemStmt = conn.prepareStatement(
                            "INSERT INTO triagem (sintomas_relato, nivel_prioridade, mensagem_id) VALUES (?, ?, NULL)")) {
                        triagemStmt.setString(1, sessionData.get("sintomas"));
                        triagemStmt.setString(2, classificarPrioridade(sessionData.get("sintomas")));
                        triagemStmt.executeUpdate();
                    }

                    // Especialidade
                    try (PreparedStatement especialidadeStmt = conn.prepareStatement(
                            "INSERT INTO especialidade (nome) VALUES (?)")) {
                        especialidadeStmt.setString(1, sessionData.get("especialidade"));
                        especialidadeStmt.executeUpdate();
                    }

                    // Agendamento
                    try (PreparedStatement agendamentoStmt = conn.prepareStatement(
                            "INSERT INTO agendamento (paciente_id, data_consulta, hora_consulta) VALUES (?, ?, ?)")) {
                        agendamentoStmt.setInt(1, pacienteId);
                        agendamentoStmt.setString(2, sessionData.get("data"));
                        agendamentoStmt.setString(3, sessionData.get("hora"));
                        agendamentoStmt.executeUpdate();
                    }
                }
            }
            conn.commit();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private String classificarPrioridade(String texto) {
        texto = texto.toLowerCase();
        if (texto.contains("urgente") || texto.contains("dor no peito") || texto.contains("falta de ar")) {
            return "Alta";
        } else if (texto.contains("febre") || texto.contains("dor de cabe√ßa") || texto.contains("tosse")) {
            return "M√©dia";
        } else {
            return "Baixa";
        }
    }

    private String formatarOpcoes(List<String> opcoes) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < opcoes.size(); i++) {
            sb.append(i + 1).append(") ").append(opcoes.get(i)).append("\n");
        }
        return sb.toString();
    }

    private void resetarConversa() {
        sessionData.clear();
        etapa = -1;
        modo = "";
        confirmacaoCancelamento = false;
        cpfParaCancelar = "";
    }

    private void returnMenuInicial(PrintWriter out) {
        out.println("Bem-vindo √† OrioAI, seu assistente de agendamento m√©dico.\n"
                + "Como podemos ajud√°-lo hoje?\n"
                + "1) Agendar uma consulta\n"
                + "2) Consultar meu agendamento\n"
                + "3) Cancelar consulta\n"
                + "Digite o n√∫mero da op√ß√£o desejada:");
    }
}
